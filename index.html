<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Nhân Sự - 人力資源報告</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4 text-center">Báo Cáo Nhân Sự - 人力資源報告</h1>

        <!-- Form Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Gửi Báo Cáo - 提交報告</h2>
            <form id="reportForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Bộ phận - 部門:</label>
                    <select name="department" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Chọn bộ phận</option>
                        <option value="Dệt gòn - 織棉">Dệt gòn - 織棉</option>
                        <option value="Chần 1 Kim - 單針絎縫">Chần 1 Kim - 單針絎縫</option>
                        <option value="Bao biên - 包邊">Bao biên - 包邊</option>
                        <option value="Cắt tự động - 自動裁剪">Cắt tự động - 自動裁剪</option>
                        <option value="Vô Nhung - 填充絨毛">Vô Nhung - 填充絨毛</option>
                        <option value="Đóng nút+ gắn nhãn - 扣釦+貼標籤">Đóng nút+ gắn nhãn - 扣釦+貼標籤</option>
                        <option value="Vô gòn Tấm - 填充棉板">Vô gòn Tấm - 填充棉板</option>
                        <option value="Sửa đồ - 修補">Sửa đồ - 修補</option>
                        <option value="Đóng Gói - 包裝">Đóng Gói - 包裝</option>
                        <option value="Kiểm Phẩm - 品質檢查">Kiểm Phẩm - 品質檢查</option>
                        <option value="Quản lí - 管理">Quản lí - 管理</option>
                        <option value="Trợ lí+ tạp vụ+khác - 助理+雜務+其他">Trợ lí+ tạp vụ+khác - 助理+雜務+其他</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Số lượng nhân viên - 員工數量:</label>
                    <input type="number" name="employeeCount" min="0" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Hộ sản - 戶產:</label>
                    <input type="number" name="householdProduction" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Khác - 其他:</label>
                    <input type="text" name="other" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Thực tế làm - 實際工作:</label>
                    <input type="number" name="actualWork" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Trực tiếp - 直接:</label>
                    <input type="number" name="direct" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Gián tiếp - 間接:</label>
                    <input type="number" name="indirect" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cho mượn - 借出:</label>
                    <input type="text" name="lent" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Tăng ca - 加班:</label>
                    <input type="number" name="overtime" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Số lượng điện thoại - 電話數量:</label>
                    <input type="number" name="phoneCount" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ngày - 日期:</label>
                    <input type="date" name="date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md hover:bg-blue-700">Gửi Báo Cáo - 提交報告</button>
            </form>
        </div>

        <!-- Report List Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Danh Sách Báo Cáo - 報告列表</h2>
            <div class="mb-4 flex flex-col sm:flex-row sm:space-x-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700">Bộ phận - 部門:</label>
                    <select id="filterDepartment" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="all">Tất cả bộ phận - 所有部門</option>
                        <option value="Dệt gòn - 織棉">Dệt gòn - 織棉</option>
                        <option value="Chần 1 Kim - 單針絎縫">Chần 1 Kim - 單針絎縫</option>
                        <option value="Bao biên - 包邊">Bao biên - 包邊</option>
                        <option value="Cắt tự động - 自動裁剪">Cắt tự động - 自動裁剪</option>
                        <option value="Vô Nhung - 填充絨毛">Vô Nhung - 填充絨毛</option>
                        <option value="Đóng nút+ gắn nhãn - 扣釦+貼標籤">Đóng nút+ gắn nhãn - 扣釦+貼標籤</option>
                        <option value="Vô gòn Tấm - 填充棉板">Vô gòn Tấm - 填充棉板</option>
                        <option value="Sửa đồ - 修補">Sửa đồ - 修補</option>
                        <option value="Đóng Gói - 包裝">Đóng Gói - 包裝</option>
                        <option value="Kiểm Phẩm - 品質檢查">Kiểm Phẩm - 品質檢查</option>
                        <option value="Quản lí - 管理">Quản lí - 管理</option>
                        <option value="Trợ lí+ tạp vụ+khác - 助理+雜務+其他">Trợ lí+ tạp vụ+khác - 助理+雜務+其他</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700">Ngày - 日期:</label>
                    <input type="date" id="filterDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex items-end space-x-2 mt-4 sm:mt-0">
                    <button id="filterBtn" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Lọc - 篩選</button>
                    <button id="resetBtn" class="bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Reset - 重置</button>
                    <button id="exportBtn" class="bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Xuất Excel - 導出Excel</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="reportTable" class="min-w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-blue-200">
                            <th class="border border-gray-300 p-2">Bộ phận - 部門</th>
                            <th class="border border-gray-300 p-2">Số lượng nhân viên - 員工數量</th>
                            <th class="border border-gray-300 p-2">Hộ sản - 戶產</th>
                            <th class="border border-gray-300 p-2">Khác - 其他</th>
                            <th class="border border-gray-300 p-2">Thực tế làm - 實際工作</th>
                            <th class="border border-gray-300 p-2">Trực tiếp - 直接</th>
                            <th class="border border-gray-300 p-2">Gián tiếp - 間接</th>
                            <th class="border border-gray-300 p-2">Cho mượn - 借出</th>
                            <th class="border border-gray-300 p-2">Tăng ca - 加班</th>
                            <th class="border border-gray-300 p-2">Số lượng điện thoại - 電話數量</th>
                            <th class="border border-gray-300 p-2">Ngày - 日期</th>
                            <th class="border border-gray-300 p-2">Thao tác - 操作</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Use google.script.run for server communication
        function callServer(action, data, callback) {
            console.log(`Calling server with action: ${action}`, data);
            google.script.run
                .withSuccessHandler(response => {
                    console.log('Server response:', response);
                    callback(null, response);
                })
                .withFailureHandler(error => {
                    console.error('Server error:', error);
                    callback(error, null);
                })
                .processRequest(action, data);
        }

        // Submit form
        document.getElementById('reportForm').addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                department: formData.get('department'),
                employeeCount: parseInt(formData.get('employeeCount')) || 0,
                householdProduction: parseInt(formData.get('householdProduction')) || 0,
                other: formData.get('other') || '',
                actualWork: parseInt(formData.get('actualWork')) || 0,
                direct: parseInt(formData.get('direct')) || 0,
                indirect: parseInt(formData.get('indirect')) || 0,
                lent: formData.get('lent') || '',
                overtime: parseInt(formData.get('overtime')) || 0,
                phoneCount: parseInt(formData.get('phoneCount')) || 0,
                date: formData.get('date')
            };

            callServer('submit', data, (error, response) => {
                if (error) {
                    alert('Lỗi kết nối: ' + error.message);
                    return;
                }
                if (response.status === 'success') {
                    alert('Báo cáo đã được gửi!');
                    e.target.reset();
                    fetchReports();
                } else {
                    alert('Lỗi: ' + response.message);
                }
            });
        });

        // Fetch and display reports
        function fetchReports() {
            callServer('fetch', {}, (error, response) => {
                if (error) {
                    alert('Lỗi kết nối: ' + error.message);
                    return;
                }
                if (response.status === 'success') {
                    const tbody = document.getElementById('reportTableBody');
                    tbody.innerHTML = '';
                    response.data.forEach(report => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="border border-gray-300 p-2">${report.department}</td>
                            <td class="border border-gray-300 p-2">${report.employeeCount}</td>
                            <td class="border border-gray-300 p-2">${report.householdProduction}</td>
                            <td class="border border-gray-300 p-2">${report.other}</td>
                            <td class="border border-gray-300 p-2">${report.actualWork}</td>
                            <td class="border border-gray-300 p-2">${report.direct}</td>
                            <td class="border border-gray-300 p-2">${report.indirect}</td>
                            <td class="border border-gray-300 p-2">${report.lent}</td>
                            <td class="border border-gray-300 p-2">${report.overtime}</td>
                            <td class="border border-gray-300 p-2">${report.phoneCount}</td>
                            <td class="border border-gray-300 p-2">${report.date}</td>
                            <td class="border border-gray-300 p-2">
                                <button class="bg-red-600 text-white p-1 rounded hover:bg-red-700 delete-btn" data-id="${report.id}">Xóa</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // Add delete event listeners
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            if (confirm('Bạn có chắc muốn xóa báo cáo này?')) {
                                const id = btn.getAttribute('data-id');
                                callServer('delete', { id }, (error, response) => {
                                    if (error) {
                                        alert('Lỗi kết nối: ' + error.message);
                                        return;
                                    }
                                    if (response.status === 'success') {
                                        alert('Báo cáo đã được xóa!');
                                        fetchReports();
                                    } else {
                                        alert('Lỗi: ' + response.message);
                                    }
                                });
                            }
                        });
                    });
                } else {
                    alert('Lỗi: ' + response.message);
                }
            });
        }

        // Filter reports
        document.getElementById('filterBtn').addEventListener('click', () => {
            const department = document.getElementById('filterDepartment').value;
            const date = document.getElementById('filterDate').value;
            fetchReports();
            const rows = document.querySelectorAll('#reportTableBody tr');
            rows.forEach(row => {
                const deptCell = row.cells[0].textContent;
                const dateCell = row.cells[10].textContent;
                const show = (department === 'all' || deptCell === department) && (!date || dateCell === date);
                row.style.display = show ? '' : 'none';
            });
        });

        // Reset filters
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('filterDepartment').value = 'all';
            document.getElementById('filterDate').value = '';
            fetchReports();
        });

        // Export to Excel
        document.getElementById('exportBtn').addEventListener('click', () => {
            callServer('export', {}, (error, response) => {
                if (error) {
                    alert('Lỗi xuất Excel: ' + error.message);
                    return;
                }
                if (response.status === 'success') {
                    const blob = new Blob([response.data], { type: 'text/csv;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'HR_Reports.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Lỗi: ' + response.message);
                }
            });
        });

        // Initial load
        fetchReports();
    </script>
</body>
</html>